name: üîÑ Daily Knowledge Hub Generator & Publisher

on:
  schedule:
    # Schedule the job to run once daily (00:00 UTC)
    - cron: '0 0 * * *' 
  workflow_dispatch:
    # Allows manual trigger from the GitHub Actions UI
    inputs:
      mode:
        description: 'SYSTEM_MODE: LIVE or TEST'
        required: true
        default: 'TEST' # Default is set to TEST for safety
        type: choice
        options:
          - LIVE
          - TEST

jobs:
  generate_and_publish:
    runs-on: ubuntu-latest
    
    # Environment variables are crucial for the script
    env:
      SYSTEM_MODE: ${{ github.event.inputs.mode || 'LIVE' }} 
      PUBLISHER_REPO_OWNER: ${{ github.repository_owner }} # Owner of the knowledge-hub repo
      PUBLISHER_REPO_NAME: knowledge-hub
      
    steps:
      - name: ‚¨áÔ∏è Checkout Factory Repo
        uses: actions/checkout@v4
        with:
          # Use PAT to allow cross-repo operations (crucial for setting up the environment path)
          token: ${{ secrets.PUBLISH_PAT }} 
          
      - name: üèóÔ∏è Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ‚öôÔ∏è Set Git User for Commit
        run: |
          # Identity used for the commit in the Factory repo
          git config --global user.email "knowledgehub-bot@users.noreply.github.com"
          git config --global user.name "Knowledge Hub Automation Bot"

      - name: üì¶ Setup Publisher Structure (Crucial for generator.py path)
        # Create the relative path where generator.py expects to write files
        run: |
          mkdir -p ../${{ env.PUBLISHER_REPO_NAME }}/content/posts/
          
      - name: üöÄ Run Generator Script
        # This step runs generator.py which creates .md files and executes 'git commit'
        run: python content-engine/generator.py
        env:
          # Pass the mode to the Python script
          SYSTEM_MODE: ${{ env.SYSTEM_MODE }} 
          
      - name: üõë Kill Switch Check (Skip Push if in TEST mode)
        if: env.SYSTEM_MODE == 'TEST'
        run: echo "SYSTEM_MODE is TEST. Skipping secure Git Push to Publisher."
        
      - name: üì§ Secure Push Generated Content (LIVE Mode Only)
        if: env.SYSTEM_MODE == 'LIVE'
        run: |
          echo "Starting secure push to ${{ env.PUBLISHER_REPO_OWNER }}/${{ env.PUBLISHER_REPO_NAME }}"
          
          # Move to the repository root
          cd .. 
          
          # Push the committed changes using the PAT to the Publisher's 'main' branch
          # The generator has already committed the changes.
          git push https://${{ github.actor }}:${{ secrets.PUBLISH_PAT }}@github.com/${{ env.PUBLISHER_REPO_OWNER }}/${{ env.PUBLISHER_REPO_NAME }}.git HEAD:main
