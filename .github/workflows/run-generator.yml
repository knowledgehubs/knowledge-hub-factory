name: ğŸ”„ Daily Knowledge Hub Generator & Publisher

on:
  schedule:
    # Schedule the job to run once daily (00:00 UTC)
    - cron: '0 0 * * *' 
  workflow_dispatch:
    # Allows manual trigger from the GitHub Actions UI
    inputs:
      mode:
        description: 'SYSTEM_MODE: LIVE or TEST'
        required: true
        default: 'TEST' # Default is set to TEST for safety
        type: choice
        options:
          - LIVE
          - TEST

jobs:
  generate_and_publish:
    runs-on: ubuntu-latest
    
    # Environment variables are crucial for the script
    env:
      SYSTEM_MODE: ${{ github.event.inputs.mode || 'LIVE' }} 
      PUBLISHER_REPO_OWNER: ${{ github.repository_owner }} # Owner of the knowledge-hub repo
      PUBLISHER_REPO_NAME: knowledge-hub
      
    steps:
      - name: â¬‡ï¸ Checkout Factory Repo
        uses: actions/checkout@v4
        with:
          # Use PAT to allow cross-repo operations (crucial for setting up the environment path)
          token: ${{ secrets.PUBLISH_PAT }} 
          
      - name: ğŸ—ï¸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ Set Git User for Commit
        run: |
          # Identity used for the commit in the Factory repo
          git config --global user.email "knowledgehub-bot@users.noreply.github.com"
          git config --global user.name "Knowledge Hub Automation Bot"

      - name: ğŸ“¦ Setup Publisher Structure (Crucial for generator.py path)
        # Create the relative path where generator.py expects to write files
        run: |
          mkdir -p ../${{ env.PUBLISHER_REPO_NAME }}/content/posts/
          
      - name: ğŸš€ Run Generator Script
        # This step runs generator.py which creates .md files and executes 'git commit'
        run: python content-engine/generator.py
        env:
          # Pass the mode to the Python script
          SYSTEM_MODE: ${{ env.SYSTEM_MODE }} 
          
      - name: ğŸ›‘ Kill Switch Check (Skip Push if in TEST mode)
        if: env.SYSTEM_MODE == 'TEST'
        run: echo "SYSTEM_MODE is TEST. Skipping secure Git Push to Publisher."
        
      - name: ğŸ§¹ Clean Git Cache
        if: env.SYSTEM_MODE == 'LIVE'
        run: |
          # Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ØªØ²ÙŠÙ„ Ø£ÙŠ Ù…Ù„ÙØ§Øª Git ØªØ§Ù„ÙØ© Ù…Ù† Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚
          rm -rf .git/objects/pack
          rm -rf .git/refs/remotes/origin

      - name: ğŸ“¤ Secure Push Generated Content (LIVE Mode Only)
        if: env.SYSTEM_MODE == 'LIVE'
        run: |
          echo "Starting secure push to ${{ env.PUBLISHER_REPO_OWNER }}/${{ env.PUBLISHER_REPO_NAME }}"
          # Ù†Ø³ØªØ®Ø¯Ù… -f Ùˆ HEAD:main Ù„Ù„Ø¯ÙØ¹ Ø§Ù„Ù‚Ø³Ø±ÙŠ Ù„ØªÙˆØ­ÙŠØ¯ Ø£Ø³Ø§Ø³ Ø§Ù„ÙØ±Ø¹ÙŠÙ†
          git push -f https://${{ github.actor }}:${{ secrets.PUBLISH_PAT }}@github.com/${{ env.PUBLISHER_REPO_OWNER }}/${{ env.PUBLISHER_REPO_NAME }}.git HEAD:main
